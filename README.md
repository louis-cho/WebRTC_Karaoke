# ë…¸ë˜ í•´ë°© ğŸµ

![homePage](/uploads/82b358dc3a816ca1cf7360edab0021e2/homePage.png)

<br />

# í”„ë¡œì íŠ¸ ì†Œê°œ

-   ë‚´ê°€ ë¶€ë¥¸ ë…¸ë˜ë¥¼ snsí˜•íƒœë¡œ ê³µìœ  í•  ìˆ˜ ìˆëŠ” ì›¹ ë…¸ë˜ë°© ì„œë¹„ìŠ¤
-   ì‹¤ì‹œê°„ìœ¼ë¡œ ì‚¬ëŒë“¤ ì•ì—ì„œ ë…¸ë˜ë¥¼ ë¶€ë¥´ê³ , í”¼ë“œì— ê³µìœ í• ìˆ˜ ìˆìŠµë‹ˆë‹¤.

## í”„ë¡œì íŠ¸ ê¸°ê°„

2024.01.04 ~ 2024.02.16

## íŒ€ì›

<table>
    <tr height="140px">
        <td align="center" width="130px">
            <a href="https://github.com/louis-cho"><img height="100px" width="100px" src="https://avatars.githubusercontent.com/u/38391852?v=4"/></a>
            <br />
            <a href="https://github.com/louis-cho">ì¡°í˜„ìš°</a>
        </td>
        <td align="center" width="130px">
            <a href="https://github.com/gardengo"><img height="100px" width="100px" src="https://avatars.githubusercontent.com/u/48192100?v=4"/></a>
            <br />
            <a href="https://github.com/gardengo">ê³ ì •ì›</a>
        </td>
        <td align="center" width="130px">
            <a href="https://github.com/seroh00"><img height="100px" width="100px" src="https://avatars.githubusercontent.com/u/139421118?v=4"/></a>
            <br />
            <a href="https://github.com/seroh00">ë…¸ì„±ì€</a>
        </td>
        <td align="center" width="130px">
            <a href="https://github.com/jsong98"><img height="100px" width="100px" src="https://avatars.githubusercontent.com/u/79959903?v=4"/></a>
            <br />
            <a href="https://github.com/jsong98">ì†¡ì¤€ì„</a>
        </td>
        <td align="center" width="130px">
            <a href="https://github.com/madirony"><img height="100px" width="100px" src="https://avatars.githubusercontent.com/u/48685874?v=4"/></a>
            <br />
            <a href="https://github.com/madirony">ì—°ì •í </a>
        </td>
        <td align="center" width="130px">
            <a href="https://github.com/bum19"><img height="100px" width="100px" src="https://avatars.githubusercontent.com/u/77481223?v=4"/></a>
            <br />
            <a href="https://github.com/bum19">ì´ì¤€ë²”</a>
        </td>
      <tr height="50px">
        <td align="center">
            <a>ìœ¼ì•„ì•„</a>
        </td>
        <td align="center">
            <a href="https://lab.ssafy.com/s10-webmobile1-sub2/S10P12A705/-/tree/develop?ref_type=heads#openvidu">OpenVidu</a>
        </td>
        <td align="center">
            <a>ìœ¼ì•„ì•„</a>
        </td>
        <td align="center">
            <a>ìœ¼ì•„ì•„</a>
        </td>
        <td align="center">
            <a>ìœ¼ì•„ì•„</a>
        </td>
        <td align="center">
            <a>ìœ¼ì•„ì•„</a>
        </td>
    </tr>
    </tr>
    
</table>

## ë§í¬

[![logo1-removebg-preview](/uploads/62539bb6b1639ad6fda02617b81db772/logo1-removebg-preview.png)](https://i10a705.p.ssafy.io/)

[![Notion](https://img.shields.io/badge/notion-000000?style=for-the-badge&logo=notion&logoColor=white)](https://www.notion.so/d3b9636405c8451499659f8d8b4ba876)

[![ERD Cloud](https://img.shields.io/badge/ERDCloud-000000?style=for-the-badge&logo=ERDCloud&logoColor=white)](https://www.erdcloud.com/d/3SsAyJ6rGXSMzyPcw)

[![Figma](https://img.shields.io/badge/figma-F24E1E?style=for-the-badge&logo=figma&logoColor=white)](<https://www.figma.com/file/cnHpMUN4kpZ55qLu2FKBD6/%5BNEW%5D-Quick-UXUI-Wireframe-templates!-(%EA%B8%B0%ED%9A%8D%EC%9E%90%EC%99%80-%EB%94%94%EC%9E%90%EC%9D%B4%EB%84%88%EB%A5%BC-%EC%9C%84%ED%95%9C-UXUI-%ED%99%94%EB%A9%B4%EA%B8%B0%ED%9A%8D%EC%84%9C%2F%ED%99%94%EB%A9%B4%EC%84%A4%EA%B3%84%EC%84%9C-%ED%85%9C%ED%94%8C%EB%A6%BF)-(Community)?type=design&node-id=103-2&mode=design&t=VZrVBeL6BKOWOGX8-0>)

<br />

# ê°œë°œ í™˜ê²½

-   **IDE** : `IntelliJ IDEA`, `Vidsual Studeo Code`
-   **BE** : `Java 11` `Spring Boot 2.7.18` `Redis 7.2.4` `MariaDB 11.2.2` `Gradle 6.8`
-   **FE** : `Node 20.11.0` `Vue 3.4.15` `Quasar 2.14.3`
-   **ETC** : `openvidu 2.29.0` `ELK 7.17.0` `Docker 25.0.1` `jenkins 2.442` `rabbitMQ 3.12.12`

<br />

# ê¸°ìˆ  ìŠ¤íƒ

## Back-end

<img src="https://img.shields.io/badge/java-007396?style=for-the-badge&logo=java&logoColor=white">
<img src="https://img.shields.io/badge/springboot-6DB33F?style=for-the-badge&logo=springboot&logoColor=white">
<img src="https://img.shields.io/badge/springsecurity-6DB33F?style=for-the-badge&logo=springsecurity&logoColor=white">
<img src="https://img.shields.io/badge/JPA-000000?style=for-the-badge&logo=jpa&logoColor=white"/>
<img src="https://img.shields.io/badge/JWT-black?style=for-the-badge&logo=JSON%20web%20tokens&logoColor=white"/>

## Front-end

<img alt="JavaScript" src ="https://img.shields.io/badge/JavaScript-F7DF1E.svg?&style=for-the-badge&logo=JavaScript&logoColor=black"/>
<img src="https://img.shields.io/badge/vue.js-4FC08D?style=for-the-badge&logo=vue.js&logoColor=white">
<img src="https://img.shields.io/badge/Quasar-16B7FB?style=for-the-badge&logo=Quasar&logoColor=white"/>
<img src="https://img.shields.io/badge/node.js-339933?style=for-the-badge&logo=nodedotjs&logoColor=white">
<img alt="Static Badge" src="https://img.shields.io/badge/pinia-F3F781.svg?style=for-the-badge">
<img alt="Static Badge" src="https://img.shields.io/badge/axios-FF00FF.svg?style=for-the-badge&logo=axios&logoColor=black">

## DB

<img src="https://img.shields.io/badge/mysql-4479A1?style=for-the-badge&logo=mysql&logoColor=white">
<img src="https://img.shields.io/badge/redis-DC382D?style=for-the-badge&logo=redis&logoColor=white">
<img src="https://img.shields.io/badge/amazons3-569A31?style=for-the-badge&logo=amazons3&logoColor=white">

## Dev-Ops

<img src="https://img.shields.io/badge/nginx-009639?style=for-the-badge&logo=nginx&logoColor=white">
<img src="https://img.shields.io/badge/amazonec2-FF9900?style=for-the-badge&logo=amazonec2&logoColor=white">
<img src="https://img.shields.io/badge/jenkins-D24939?style=for-the-badge&logo=jenkins&logoColor=white">
<img src="https://img.shields.io/badge/docker-2496ED?style=for-the-badge&logo=docker&logoColor=white">

## í˜‘ì—…Tools

<img src="https://img.shields.io/badge/figma-F24E1E?style=for-the-badge&logo=figma&logoColor=white">
<img src="https://img.shields.io/badge/jira-0052CC?style=for-the-badge&logo=jira&logoColor=white">
<img src="https://img.shields.io/badge/notion-000000?style=for-the-badge&logo=notion&logoColor=white">
<img src="https://img.shields.io/badge/gitlab-FC6D26?style=for-the-badge&logo=gitlab&logoColor=white">

## ETC

<img src="https://img.shields.io/badge/webrtc-FFE033?style=for-the-badge&logo=webrtc&logoColor=white">
<img src="https://img.shields.io/badge/rabbitmq-FF6600?style=for-the-badge&logo=rabbitmq&logoColor=white">
<img src="https://img.shields.io/badge/elasticsearch-005571?style=for-the-badge&logo=elasticsearch&logoColor=white">
<img src="https://img.shields.io/badge/logstash-005571?style=for-the-badge&logo=logstash&logoColor=white">
<img src="https://img.shields.io/badge/kibana-005571?style=for-the-badge&logo=kibana&logoColor=white">

<br />

# ì£¼ìš” ê¸°ëŠ¥

-   webRTCì™€ í™œìš©í•œ ì‹¤ì‹œê°„ í™”ìƒ ë…¸ë˜ë°© í™˜ê²½ ì œê³µ
-   2ê°€ì§€ ë…¸ë˜ë°© ëª¨ë“œ
    -   ì¼ë°˜ ë…¸ë˜ë°©
        -   MRê³¼ ê°€ì‚¬ ì œê³µ
        -   ë…¹í™”
    -   í¼í™íŠ¸ ìŠ¤ì½”ì–´
        -   ì‚¬ìš©ìì˜ ìŒì„± ë°ì´í„° ë¶„ì„
        -   ë¶„ì„ëœ ë°ì´í„°ë¡œ ìŒì • í‰ê°€
-   ë…¸ë˜ë°© ë¶€ê°€ ê¸°ëŠ¥
    -   ì¸ì›ì œí•œ, ë¹„ë°€ë²ˆí˜¸ ì„¤ì •
    -   ì¶”ë°©
    -   ì±„íŒ…
    -   ì…ë ¥ ë³€ê²½
    -   ì¢…ë£Œ í›„ í”¼ë“œ ì‘ì„±
-   ì‹¤ì‹œê°„ ì•Œë¦¼
-   ë…¹í™”ëœ ì˜ìƒì„ sns í”¼ë“œ í˜•íƒœë¡œ ê³µìœ 
-   DM
-   ë°©ìƒì„±
-   ì´ˆëŒ€
-   ì‹¤ì‹œê°„ ì±„íŒ…

<br />

# í™”ë©´

<<ë„ë©”ì¸ ë³„ë¡œ>>
gif í™”ë©´ ì¶”ê°€

<br />

# ì•„í‚¤ë„¥ì²˜ êµ¬ì„±ë„

![a705.drawio](/uploads/2f07ef3d0808a1239f11647ffaeb4f9a/a705.drawio.png)

<br />

<details>
<summary> <h1> Elastic Search </h1> </summary>
<div markdown="1">

### ìœ ì € ê²€ìƒ‰

íšŒì›ê°€ì… ì‹œ Elasticsearchì—ì„œ ì‚¬ìš©í•˜ëŠ” UserDocument íƒ€ì… ë°ì´í„°ë¥¼ ì €ì¥í•©ë‹ˆë‹¤.<br>
UserDocumentëŠ” userPk(int), nickname(String)ì„ ê°–ê³  ìˆì–´ ElasticsearchRepositoryë¥¼ í†µí•´ ìœ ì € ë‹‰ë„¤ì„ ê¸°ë°˜ ê²€ìƒ‰ì„ ê°€ëŠ¥í•˜ê²Œ í•©ë‹ˆë‹¤.<br>
ë˜í•œ ìœ ì‚¬ë„ ìˆëŠ” ê²€ìƒ‰ ê²°ê³¼ë„ ë³´ì—¬ì¤„ ìˆ˜ ìˆë„ë¡ Elasticsearch Queryì˜ fuzzinessì˜ ìœ ì—°ì„±ì„ ì„¤ì •í•˜ì˜€ìŠµë‹ˆë‹¤.

```java
    // UserServiceImpl.java
    @Override
    public List<UserDocument> searchUsersByNickname(String nickname) {
        NativeSearchQuery searchQuery = new NativeSearchQueryBuilder()
                .withQuery(fuzzyQuery("nickname", nickname).fuzziness(Fuzziness.TWO))
                .build();

        SearchHits<UserDocument> searchHits = elasticsearchRestTemplate.search(searchQuery, UserDocument.class);
        return searchHits.stream().map(SearchHit::getContent).collect(Collectors.toList());
    }
```

### ì¸ê¸° í”¼ë“œ ë­í‚¹ ê³„ì‚°

ì¸ê¸° í”¼ë“œ ë­í‚¹ì€ Elasticsearchì— ë™ê¸°í™”ëœ ë°ì´í„°ë¥¼ ìŠ¤ì¼€ì¤„ë§ì„ í†µí•´ ì¼ì • ì£¼ê¸°ë¡œ ìƒˆë¡­ê²Œ ì¶”ê°€ëœ ë°ì´í„°ë¥¼ ëŒ€ìƒìœ¼ë¡œ ê³„ì‚°ë©ë‹ˆë‹¤.<br>
ê° í”¼ë“œ ë³„ ì ìˆ˜ì— ì˜í–¥ì„ ë¯¸ì¹˜ëŠ” ìš”ì¸ì€ ì¢‹ì•„ìš” ê°œìˆ˜ì™€ ì¡°íšŒìˆ˜ê°€ ìˆìœ¼ë©° ê°ê°ì€ 5:3ì˜ ê°€ì¤‘ì¹˜ë¥¼ ê°–ê³  ê³„ì‚°ë©ë‹ˆë‹¤.<br>
ì—…ë°ì´íŠ¸ëœ í”¼ë“œ ë­í‚¹ì€ ìƒìœ„ 100ê°œì˜ í”¼ë“œê°€ ë‚´ë¦¼ì°¨ìˆœìœ¼ë¡œ ì •ë ¬ë©ë‹ˆë‹¤. ì´ ê²°ê³¼ë¬¼ì€ ì¡°íšŒê°€ ìì£¼ ì¼ì–´ë‚  ê²ƒì´ ì˜ˆìƒë˜ë¯€ë¡œ ë©”ëª¨ë¦¬ ë³€ìˆ˜ í˜•íƒœë¡œ ìœ ì§€ ê´€ë¦¬í•©ë‹ˆë‹¤.<br>

```java
    @Scheduled(cron = "0 */15 * * * *")
    public void calculateRank() {
        String likesIndexName = "likes";
        String hitIndexName = "hits";

        List<SearchHit> likesData = fetchDataFromElasticsearch(likesIndexName);

        List<SearchHit> hitsData = fetchDataFromElasticsearch(hitIndexName);

        // ê° ê²Œì‹œê¸€ ì•„ì´ë”” ë³„ë¡œ ì ìˆ˜ ê³„ì‚°
        calculateScores(likesData, hitsData);

        // ìƒìœ„ 100ê°œ ê²Œì‹œê¸€ë§Œ ì„ íƒ
        updateTop100Ranking();
    }

     private void updateTop100Ranking() {
           try {
            top100Ranking = elasticsearchRestTemplate.search(
                            new NativeSearchQueryBuilder()
                                    .withPageable(PageRequest.of(0, 100, Sort.by(Sort.Order.desc("score"))))
                                    .build(), FeedStatsDocument.class)
                    .stream()
                    .map(searchHit -> (FeedStatsDocument) searchHit.getContent())
                    .collect(Collectors.toList());
            } catch (...) {
               ...
            }
    }
```

### MySQL, Elasticsearch ë™ê¸°í™”

MySQL DBì™€ Elasticsearch DocumentëŠ” ì„œë¡œ ë™ê¸°í™”ë˜ì–´ ì¼ê´€ì„±ì„ ìœ ì§€í•´ì•¼ í•©ë‹ˆë‹¤. ì´ë¥¼ ë§Œì¡±ì‹œí‚¤ê¸° ìœ„í•´ logstashë¥¼ í™œìš©í•˜ì˜€ìŠµë‹ˆë‹¤. <br>
í¬ë¡ ì‹ í‘œí˜„ì„ í†µí•´ ì¼ì • ì£¼ê¸°ë¡œ ë™ê¸°í™” ì‘ì—…ì´ ì´ë¤„ì§€ë„ë¡ êµ¬ì„±í•˜ì˜€ìŠµë‹ˆë‹¤. <br>
ì¢‹ì•„ìš”, ì¡°íšŒìˆ˜ ì •ë³´ëŠ” ê° DB SELECT ë¬¸ì„ í†µí•´ fetch ì‹œ timestampë¥¼ ê¸°ì¤€ìœ¼ë¡œ ìƒˆë¡œìš´ ë°ì´í„°ë§Œ ê°€ì ¸ì˜¤ë„ë¡ ì‘ì„±í•˜ì˜€ìŠµë‹ˆë‹¤. <br>
ì´ë¥¼ ê°ê°ì˜ Elasticsearch Documentì— í•´ë‹¹í•˜ëŠ” indexë¡œ ë°ì´í„°ë¥¼ ì „ë‹¬í•˜ë„ë¡ ì„¤ì •í•˜ì˜€ìŠµë‹ˆë‹¤.

```
input {

  jdbc {
    jdbc_connection_string => "jdbc:mysql://i10a705.p.ssafy.io:3306/karaoke"
    jdbc_user => "root"
    jdbc_password => "1234"
    jdbc_driver_library => "/logstash_dir/mysql-connector-java-8.0.30.jar"
    jdbc_driver_class => "com.mysql.cj.jdbc.Driver"

    statement => "SELECT * FROM likes WHERE timestamp > :sql_last_value"

    schedule => "*/10 * * * * *"
    use_column_value => true
    tracking_column => "timestamp"
    tracking_column_type => "timestamp"
    clean_run => false
    type => "like"
  }

  jdbc {
    ...
  }
}

output {
  if [type] == "like" {
    elasticsearch {
      hosts => ["elasticsearch:9200"]
      index => "likes"
    }
  }

  if [type] == "hit" {
  	...
  }

  stdout { codec => rubydebug }
}

output {
  if [type] == "like" {
    elasticsearch {
      hosts => ["localhost:9200"]
      index => "like"                             # indexë¥¼ likeë¡œ ë°ì´í„° ë™ê¸°í™”
    }
  }

  if [type] == "view" {
    ...
  }
}
```
</div>
</details>

<details>
<summary> <h1> ì—ëŸ¬ ì²˜ë¦¬ </h1> </summary>
<div markdown="1">

### ë™ì¼í•œ ì²˜ë¦¬ êµ¬ì¡°

@RestControllerAdvice annotationì„ í†µí•´ ì˜ˆì™¸ì— ë”°ë¼ ëª¨ë“  ê²°ê³¼ë¬¼ì´ ë™ì¼í•œ ë¡œì§ì„ ê±°ì³ ì „ë‹¬ë˜ë„ë¡ êµ¬í˜„í•˜ì˜€ìŠµë‹ˆë‹¤. <br>

### Generic Type. ì¼ê´€ëœ ë°˜í™˜ íƒ€ì…

@ExceptionHandler(ApiException.class) annotationì„ í†µí•´ ApiException í´ë˜ìŠ¤ì˜ ì˜ˆì™¸ëŠ” ì œë„¤ë¦­ íƒ€ì…ì˜ ì¼ê´€ëœ ë¦¬í„´ íƒ€ì… ResponseEntity<ApiResponse<?>>ì„ ê°–ë„ë¡ êµ¬í˜„í•˜ì˜€ìŠµë‹ˆë‹¤.

```java
@RestControllerAdvice
public class ApiExceptionAdvice {

    @ExceptionHandler(ApiException.class)
    @ResponseStatus
    public ResponseEntity<ApiResponse<?>> handleApiException(HttpServletRequest request, ApiException e) {

        return ResponseEntity
                .status(e.getStatus())
                .body(ApiResponse.builder()
                        .status(String.valueOf(e.getStatus()))
                        .message(e.getCode())
                        .data(null)
                        .build());
    }
}
```

### ì—ëŸ¬ ì •ì˜. Enum Type í™œìš©

ê° ë„ë©”ì¸ ë³„ ì—ëŸ¬ íƒ€ì…ì„ Enum Typeì„ í†µí•´ ì¼ê´€ì„±ì„ ê°–ì¶° êµ¬í˜„í•˜ì˜€ìŠµë‹ˆë‹¤. í…ŒìŠ¤íŠ¸ ë‹¨ê³„ì—ì„œ ìš”ì²­ ì‹¤íŒ¨ì— ëŒ€í•´ì„œ ì–´ë–¤ ì˜ˆì™¸ê°€ ë°œìƒí–ˆëŠ”ì§€ ë¹ ë¥´ê²Œ íŒŒì•…í•˜ê³  ê´€ë¦¬í•  ìˆ˜ ìˆë„ë¡ í•˜ì˜€ìŠµë‹ˆë‹¤.

```JAVA
public enum CommentExceptionEnum implements ExceptionEnum {
    COMMENT_NOT_FOUND(HttpStatus.NOT_FOUND, "C00001", "ëŒ“ê¸€ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤"),
    COMMENT_CREATION_FAILED(HttpStatus.BAD_REQUEST, "C00002", "ëŒ“ê¸€ì„ ìƒì„±í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤"),
    COMMENT_UPDATE_FAILED(HttpStatus.BAD_REQUEST, "C00003", "ëŒ“ê¸€ì„ ì—…ë°ì´íŠ¸í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤"),
    ...
}
```

```JAVA
public enum LikeExceptionEnum implements ExceptionEnum {

    LIKE_NOT_FOUND(HttpStatus.NOT_FOUND, "L00001", "ì¢‹ì•„ìš”ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤"),
    LIKE_CREATION_FAILED(HttpStatus.BAD_REQUEST, "L00002", "ì¢‹ì•„ìš”ë¥¼ ìƒì„±í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤"),
    LIKE_UPDATE_FAILED(HttpStatus.BAD_REQUEST, "L00003", "ì¢‹ì•„ìš”ë¥¼ ì—…ë°ì´íŠ¸í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤"),
    ...
}
```
</div>
</details>


<details>
<summary> <h1> íšŒì› ì •ë³´ ì•”í˜¸í™” ê´€ë¦¬ </h1> </summary>
<div markdown="1">

### RSA ì•”ë³µí˜¸í™”

RSA 2048 bit + bcrypt hashë¥¼ ê¸°ë°˜ìœ¼ë¡œ ì œì‘í•˜ì˜€ìŠµë‹ˆë‹¤. <br>
ì„œë²„ëŠ” ìœ ì €ê°€ ë¡œê·¸ì¸ ë° íšŒì›ê°€ì…ì„ í•„ìš”ë¡œ í•˜ëŠ” í˜ì´ì§€ì— ì ‘ì† ì‹œ ìœ ì € ipì— ë”°ë¼ RSA ë¹„ëŒ€ì¹­í‚¤ ìŒì„ ìƒì„±í•œ ë’¤, ì´ë¥¼ ê´€ë¦¬í•©ë‹ˆë‹¤. <br>
jsbn, prng4, rng, rsa js íŒŒì¼ì„ es6 í˜•íƒœì— ë§ê²Œ í¬íŒ…í•˜ì˜€ìœ¼ë©° ì´ë¥¼ í†µí•´ ì„œë²„ ì‘ë‹µìœ¼ë¡œ ë„˜ì–´ì˜¨ modulus, exponent public keyë¥¼ ê¸°ë°˜ìœ¼ë¡œ ë¹„ë°€ë²ˆí˜¸ ì•”í˜¸í™”ë¥¼ ìˆ˜í–‰í•©ë‹ˆë‹¤.<br>
ê³µê°œí‚¤ë¡œ ì•”í˜¸í™”ëœ ì •ë³´ëŠ” ì„œë²„ ì¸¡ì˜ ë¹„ë°€í‚¤ë¡œ ë³µí˜¸í™”í•œ ì›ë¬¸ íŒ¨ìŠ¤ì›Œë“œì™€ SALTING ê¸°ëŠ¥ì´ ë‚´ì¥ëœ bcrypt í•´ì‹± ê²°ê³¼ë¥¼ DBë¡œë¶€í„° ê°€ì ¸ì™€ ë¹„êµí•©ë‹ˆë‹¤.<br>
ì´ë¥¼ í†µí•´ ì‚¬ìš©ì ë¹„ë°€ë²ˆí˜¸ ì›ë¬¸ì„ ì €ì¥í•˜ì§€ ì•Šê³  ë¡œê·¸ì¸ ì¸ì¦ ì„±ê³µ/ì‹¤íŒ¨ íŒë‹¨ì´ ê°€ëŠ¥í•©ë‹ˆë‹¤.

```javascript
    // ì•”í˜¸í™” ê³¼ì • (í´ë¼ì´ì–¸íŠ¸)
    import * as RSA from "./rsa.js";
    export let rsa = new RSA.RSAKey();
    ...
    {
        pw: rsa.encrypt(pw),
    }
```

```JAVA
    // ë³µí˜¸í™” ê³¼ì • (ì„œë²„)
   String privateKey = RSA_2048.keyToString(keyManager.getPrivateKey(ip));
   String password = RSA_2048.decrypt(rawPassword, privateKey);

   // ë¹„ë°€ë²ˆí˜¸ë¥¼ í•´ì‹±í•˜ì—¬ ì €ì¥
   String hashedPassword = passwordEncoder.encode(password);

   // ìƒì„±ëœ í•´ì‹œëœ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì‚¬ìš©í•˜ì—¬ ì‚¬ìš©ì ì—”í„°í‹°ë¥¼ ìƒì„±
   UserAuth userAuth = new UserAuth(id, hashedPassword);
```

### RSA Key Manager

ë¹„ëŒ€ì¹­í‚¤ ìŒì€ ì„œë²„ ë©”ëª¨ë¦¬ ë³€ìˆ˜ë¡œ ê´€ë¦¬ë©ë‹ˆë‹¤. RSA Key ManagerëŠ” ì‹±ê¸€í†¤ íŒ¨í„´ìœ¼ë¡œ ê´€ë¦¬ë˜ë©°, ë‚´ë¶€ì—ëŠ” ê° í´ë¼ì´ì–¸íŠ¸ì˜ ë§ˆì§€ë§‰ ì¡°íšŒ ì‹œê°ì„ ì˜ë¯¸í•˜ëŠ” lastRequestì™€ í´ë¼ì´ì–¸íŠ¸ì˜ ipë¥¼ key ê°’ìœ¼ë¡œ rsa key pairê°€ ì €ì¥ëœ hash mapì´ ì¡´ì¬í•©ë‹ˆë‹¤.<br>
ì´ëŠ” ìŠ¤ì¼€ì¤„ëŸ¬ë¥¼ í†µí•´ ì¼ì • ì£¼ê¸°ë§ˆë‹¤ ë§ˆì§€ë§‰ í‚¤ ì¡°íšŒ ìš”ì²­ìœ¼ë¡œë¶€í„° 10ë¶„ì´ ì§€ë‚œ í‚¤ëŠ” ì‚­ì œí•˜ì—¬ ë©”ëª¨ë¦¬ ë‚­ë¹„ë¥¼ ì¤„ì¼ ìˆ˜ ìˆë„ë¡ ì‘ì„±í•˜ì˜€ìŠµë‹ˆë‹¤.

```java
public class RSAKeyManager { // í´ë¼ì´ì–¸íŠ¸ ip ë¥¼ í‚¤ë¡œ ê´€ë¦¬í•˜ëŠ” ë¹„ëŒ€ì¹­í‚¤ ìŒ & ë§ˆì§€ë§‰ ìš”ì²­ ì‹œê°
    private static HashMap<String, KeyPair> keyMap;
    private static HashMap<String, Long> lastRequest;
    private static RSAKeyManager instance = null;
    ...
}

@Component
public class RSAKeyManagerCleanupTask {

    private final int period = 600000;

    @Scheduled(fixedRate = period)
    public void cleanupUnusedKeys() { // ì‚¬ìš©í•˜ì§€ ì•ŠëŠ” ë¹„ëŒ€ì¹­ í‚¤ ìŒì„ ì‚­ì œí•©ë‹ˆë‹¤
      ...
    }
}
```
</div>
</details>


<details>
<summary> <h1> ì¢‹ì•„ìš”, ì¡°íšŒìˆ˜ ë°ì´í„° ë™ê¸°í™” </h1> </summary>
<div markdown="1">


ì¢‹ì•„ìš”, ì¡°íšŒìˆ˜ê°€ ê¸‰ì¦í•˜ëŠ” ê²Œì‹œê¸€ í”¼ë“œì— ëŒ€í•´ ë°”ë¡œ DB write ìš”ì²­ì´ ì¼ì–´ë‚œë‹¤ë©´ ë§ì€ ë¶€í•˜ê°€ ì¼ì–´ë‚  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì´ë¥¼ í•´ê²°í•˜ê¸° ìœ„í•´ Redis cacheë¥¼ ì‚¬ìš©í•˜ì—¬ DB writeê°€ ê° ìš”ì²­ì— ëŒ€í•´ ë§¤ë²ˆ ì¼ì–´ë‚˜ëŠ” ê²ƒì„ ë°©ì§€í•˜ì˜€ìŠµë‹ˆë‹¤.<br>
ì‚¬ìš©ì ìš”ì²­ì— ëŒ€í•´ ìš°ì„ ì ìœ¼ë¡œëŠ” Redis cacheì— ì €ì¥í•˜ì˜€ìœ¼ë©°, ì´ë¥¼ ì¼ì • ì£¼ê¸°ë¡œ ë¹„ë™ê¸° DB ë™ê¸°í™”ë¥¼ í†µí•´ í•´ê²°í•˜ê³ ì í–ˆìŠµë‹ˆë‹¤.<br>
ë˜í•œ ê²Œì‹œê¸€ì— ëŒ€í•œ í†µê³„ ì •ë³´ë¥¼ ê´€ë¦¬í•˜ëŠ” í…Œì´ë¸”ì„ ìƒì„±í•˜ì—¬ ê° ê²Œì‹œê¸€ì˜ ì¢‹ì•„ìš”, ì¡°íšŒìˆ˜ ì •ë³´ë¥¼ ë¹ ë¥´ê²Œ í™•ì¸í•  ìˆ˜ ìˆë„ë¡ êµ¬í˜„í•˜ì˜€ìŠµë‹ˆë‹¤.<br>

```java
    @Async
    public CompletableFuture<Void> saveToMySQLAsync() {
        HashOperations<String, Object, Object> hashOperations = redisTemplate.opsForHash();
        long count = hashOperations.scan(LIKE_HASH_KEY, ScanOptions.scanOptions().match("*").build()).stream().count();

        hashOperations.scan(LIKE_HASH_KEY, ScanOptions.scanOptions().match("*").build())
                .forEachRemaining(entry -> {
                       Like like = (Like) entry.getValue();
                         // ì¡°ê±´ì— ë”°ë¼ redis ë°ì´í„°ë¥¼ mysql í…Œì´ë¸” ë™ê¸°í™”
                         ...
                       );
                        hashOperations.delete(LIKE_HASH_KEY, entry.getKey());
                        return;
                    }

                    Like elem = list.get(0);
                    if (like.isStatus() == elem.isStatus()) {
                       // ìƒíƒœê°€ ê°™ì€ ê²½ìš° ì•„ë¬´ ê²ƒë„ ìˆ˜í–‰í•˜ì§€ ì•ŠëŠ”ë‹¤
                       ...
                    } else {
                      //  ë‹¤ë¥¸ ê²½ìš° ì§‘ê³„ í…Œì´ë¸” ë™ê¸°í™”
                      ...
                    }

                    // ì €ì¥ í›„ í•´ë‹¹ ë°ì´í„°ë¥¼ í•´ì‹œì—ì„œ ì‚­ì œ
                    hashOperations.delete(LIKE_HASH_KEY, entry.getKey());
                });

        // ë¹„ë™ê¸° ì‘ì—… ì™„ë£Œ
        return CompletableFuture.completedFuture(null);
    }
```
</div>
</details>

<details>
<summary> <h1> í”„ë¡œì‹œì € ì ìš© </h1> </summary>
<div markdown="1">

SQLì„ ë°±ì—”ë“œ ì„œë²„ì—ì„œ ìƒì„±í•˜ì—¬ DB ìš”ì²­í•˜ê¸° ë³´ë‹¤ëŠ” pre-compiled procedureë¥¼ í†µí•´ DB ì‘ì—… ì„±ëŠ¥ ê°œì„ ì„ ì´ëŒì–´ ë‚´ë©° í•œ ë²ˆì˜ ìˆ˜ë§ì€ ëŒ“ê¸€ì„ ë¡œë“œí•˜ì§€ ì•Šê³  í˜ì´ì§€ë„¤ì´ì…˜ì„ í†µí•´ íš¨ìœ¨ì„ ì¶”êµ¬í•˜ì˜€ìŠµë‹ˆë‹¤.

```
CREATE DEFINER=`root`@`%` PROCEDURE `GetCommentsByFeedIdWithPagination`(
    IN feedIdParam INT,
    IN startIndexParam INT,
    IN pageSizeParam INT
)
BEGIN
    SELECT *
    FROM comment
    WHERE feed_id = feedIdParam
      AND LOWER(is_deleted) NOT LIKE 'o%'
    ORDER BY comment_id
    LIMIT startIndexParam, pageSizeParam;
END
```
</div>
</details>

<details>
<summary> <h1> ì‹œìŠ¤í…œ ë‚´ì™¸ë¶€ user key êµ¬ì¡° </h1> </summary>
<div markdown="1">

user keyê°€ ì™¸ë¶€ì— ë…¸ì¶œë˜ë©´ í•´ë‹¹ idì˜ ìœ ì €ë¥¼ íŠ¹ì •í•  ìˆ˜ ìˆì–´ ë³´ì•ˆì— ì¢‹ì§€ ì•Šì€ ë°©ì‹ì´ë¼ ìƒê°í–ˆìŠµë‹ˆë‹¤.<br>
ê·¸ëŸ¼ì—ë„ ë¶ˆêµ¬í•˜ê³  Auto Increment ì†ì„±ì„ í†µí•´ ìƒì„± ì‹œê° ë³„ë¡œ ì •ë ¬ë˜ì–´ ìˆìœ¼ë©´ì„œë„, ë°ì´í„° ì¡°íšŒì— ìˆì–´ì„œ ë¹ ë¥¸ int í˜•íƒœì˜ user keyë¥¼ ì“°ëŠ” ê²ƒì´ ì„±ëŠ¥ë©´ì—ì„œ ì¢‹ë‹¤ê³  ìƒê°í–ˆìŠµë‹ˆë‹¤.<br>
ë‘ê°€ì§€ ì¸¡ë©´ ëª¨ë‘ ë†“ì¹˜ì§€ ì•Šê¸° ìœ„í•´ ë‘ê°€ì§€ ë°©ë²• ëª¨ë‘ ì‚¬ìš©í•˜ì˜€ìœ¼ë©° ì´ë¥¼ ìœ„í•´ int uesr keyì™€ uuid user key ì‚¬ì´ì˜ ë³€í™˜ì„ ë‹´ë‹¹í•˜ëŠ” ë§¤í•‘ í…Œì´ë¸”ì„ ì¶”ê°€í•˜ì—¬
ë©”ì†Œë“œë¥¼ í†µí•´ uuidë¥¼ int íƒ€ì…ìœ¼ë¡œ ë°”ê¿€ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

```JAVA
int userPk = userService.getUserPk(UUID.fromString(uuid));
```

### ë‚´ë¶€ ì‹œìŠ¤í…œ user key

í´ë¼ì´ì–¸íŠ¸ì—ê²Œ ë…¸ì¶œë˜ì§€ ì•Šê³  ë°±ì—”ë“œ ì„œë²„ ë‚´ë¶€ì—ì„œ ì‚¬ìš©ë˜ëŠ” user keyì˜ ê²½ìš° int í˜•íƒœì˜ ë°ì´í„°ë¥¼ ì‚¬ìš©í•˜ë„ë¡ êµ¬í˜„í•˜ì˜€ìŠµë‹ˆë‹¤.

### ì™¸ë¶€ ì‹œìŠ¤í…œ user key

í´ë¼ì´ì–¸íŠ¸ì—ê²Œ ë…¸ì¶œë˜ëŠ” ì •ë³´ì˜ ê²½ìš° int user keyë¥¼ uuid user keyë¡œ ë³€í™˜í•˜ì—¬ ì‘ë‹µí•˜ë„ë¡ ì‘ì„±í•˜ì˜€ìŠµë‹ˆë‹¤.<br>
ì´ëŠ” ë¹„ë‹¨ ìœ ì € í´ë˜ìŠ¤ ë¿ ì•„ë‹ˆë¼ í”¼ë“œ, ëŒ“ê¸€, ì¢‹ì•„ìš” ë“±ì— ë‹´ê²¨ ìˆëŠ” user key ì •ë³´ë„ ë§ˆì°¬ê°€ì§€ë¡œ int íƒ€ì…ì´ ì•„ë‹Œ uuidë¥¼ ë°˜í™˜í•˜ë„ë¡ ì ìš©ë˜ì—ˆìŠµë‹ˆë‹¤.
</div>
</details>


<details>
<summary> <h1> OpenVidu </h1> </summary>
<div markdown="1">

<img src="https://lab.ssafy.com/s10-webmobile1-sub2/S10P12A705/uploads/d3aba65d32a825af084d40eb56ad8e18/openvidu-workflow-server.png" width="500" height="500"/>

### Application Client

<div>
OpenViduë¥¼ ì‚¬ìš©í•˜ê¸° ìœ„í•´ì„œëŠ” ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ í†µí•´ ê°ì²´ë¥¼ ë§Œë“¤ì–´ì•¼í•©ë‹ˆë‹¤. ì£¼ë¡œ ì‚¬ìš©í•˜ëŠ” ê°ì²´ëŠ” OpenVidu, Session, Connection, Publisher, Subscriber ë“±ì´ ìˆê³  ìˆœì„œëŒ€ë¡œ ê°ì²´ë¥¼ ë§Œë“¤ì–´ë‚˜ê°€ë©´ ë©ë‹ˆë‹¤.
</div>

```javascript
// ì´ˆê¸° ê°ì²´ ìƒì„±
OV = new OpenVidu();
session = OV.initSession();
```

<div>
Session ê°ì²´ë¥¼ ë§Œë“¤ê³  ë‚˜ë©´ ì´ë²¤íŠ¸ë¥¼ ì„¤ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. streamCreated, streamDestroyed, sessionDisconnected, signal ë“±ì˜ ì´ë²¤íŠ¸ë¥¼ ì„¤ì •í•  ìˆ˜ ìˆê³  ë°©ë²•ì€ ì•„ë˜ì™€ ê°™ìŠµë‹ˆë‹¤. ì˜ˆì‹œëŠ” Sessionì— ìƒˆë¡œìš´ Subscriberê°€ ë“¤ì–´ì™€ Streamì´ ìƒê¸°ë©´ í•´ë‹¹ Streamì„ êµ¬ë…í•˜ê³  ê´€ë¦¬í•˜ëŠ” ê²ƒì…ë‹ˆë‹¤.
</div>

```javascript
// Sessionì— ì´ë²¤íŠ¸ ì„¤ì •
session.on('streamCreated', ({ stream }) => {
    const subscriber = session.subscribe(stream, undefined, {
        subscribeToAudio: true,
        subscribeToVideo: true,
    });

    subscribers.push(subscriber);
});
```

<div>
ì´ì œ Tokenì„ ì–»ì–´ì˜¬ ì°¨ë¡€ì…ë‹ˆë‹¤. ì…ë ¥í•œ SessionIdì™€ ì¼ì¹˜í•˜ëŠ” Sessionì´ ì¡´ì¬í•˜ë©´ í•´ë‹¹ Sessionê³¼ ì—°ê²°ëœ Connection ê°ì²´ì˜ Tokenì„ ì–»ì–´ì˜µë‹ˆë‹¤. ì´ ì‘ì—…ì€ Serverì—ì„œ ì´ë£¨ì–´ì§€ê¸° ë•Œë¬¸ì— Clientì—ì„œëŠ” ìš”ì²­ë§Œ ë³´ëƒ…ë‹ˆë‹¤.
</div>

```javascript
const token = await axios.post(
    APPLICATION_SERVER_URL + '/karaoke/sessions/getToken',
    {
        sessionName: sessionName,
        // filter ì‚¬ìš©ì„ ìœ„í•œ ì„¤ì •ë“¤
        type: 'WEBRTC',
        role: 'PUBLISHER',
        kurentoOptions: {
            allowedFilters: ['GStreamerFilter', 'FaceOverlayFilter'],
        },
    },
    {
        headers: {
            Authorization: getCookie('Authorization'),
            refreshToken: getCookie('refreshToken'),
            'Content-Type': 'application/json',
        },
    }
);
```

<div>
ì–»ì–´ì˜¨ Tokenìœ¼ë¡œ Sessionì— ì—°ê²°í•©ë‹ˆë‹¤. ì´í›„ì— Publisherë¥¼ ë§Œë“¤ê³  Sessionì— ë°œí–‰í•©ë‹ˆë‹¤. subscribeToRemote()ëŠ” ì›ê²© ìŠ¤íŠ¸ë¦¼ì„ ìˆ˜ì‹ í•˜ê¸° ìœ„í•œ ì„¤ì •ìœ¼ë¡œ, ìœ„ì—ì„œ ì„¤ì •í–ˆë˜ ì´ë²¤íŠ¸ë¥¼ ìˆ˜ì‹ í•˜ê¸° ìœ„í•´ í•„ìš”í•©ë‹ˆë‹¤.
</div>

```javascript
session.connect(token.data, { clientData: userName }).then(() => {
    // ì›í•˜ëŠ” ì†ì„±ìœ¼ë¡œ ì´ˆê¸°í™”ëœ ë°œí–‰ìë¥¼ ë§Œë“­ë‹ˆë‹¤.
    let publisher_tmp = OV.initPublisher(undefined, {
        audioSource: undefined, // ì˜¤ë””ì˜¤ì˜ ì†ŒìŠ¤. ì •ì˜ë˜ì§€ ì•Šìœ¼ë©´ ê¸°ë³¸ ë§ˆì´í¬
        videoSource: undefined, // ë¹„ë””ì˜¤ì˜ ì†ŒìŠ¤. ì •ì˜ë˜ì§€ ì•Šìœ¼ë©´ ê¸°ë³¸ ì›¹ìº 
        publishAudio: true, // ë§ˆì´í¬ ìŒì†Œê±° ì—¬ë¶€ë¥¼ ì‹œì‘í• ì§€ ì—¬ë¶€
        publishVideo: true, // ë¹„ë””ì˜¤ í™œì„±í™” ì—¬ë¶€ë¥¼ ì‹œì‘í• ì§€ ì—¬ë¶€
        resolution: '320x240',
        frameRate: 30, // ë¹„ë””ì˜¤ì˜ í”„ë ˆì„ ì†ë„
        insertMode: 'APPEND', // ë¹„ë””ì˜¤ê°€ ëŒ€ìƒ ìš”ì†Œ 'video-container'ì— ì–´ë–»ê²Œ ì‚½ì…ë˜ëŠ”ì§€
        mirror: true, // ë¡œì»¬ ë¹„ë””ì˜¤ë¥¼ ë°˜ì „í• ì§€ ì—¬ë¶€
    });

    publisher = publisher_tmp;

    // ì›ê²© ìŠ¤íŠ¸ë¦¼ì„ ìˆ˜ì‹ í•˜ê¸°ìœ„í•´ subscribeToRemote() í˜¸ì¶œ
    publisher.subscribeToRemote();
    session.publish(publisher);
});
```

### Application Server

<div>
Serverì—ì„œëŠ” Session, Connection, Recording ê°ì²´ì˜ ìƒì„±, ì‚­ì œ ë“±ì˜ ê´€ë¦¬ë¥¼ í•©ë‹ˆë‹¤. ìš°ì„  Clientì˜ ìš”ì²­ì„ ë°›ì•„ Sessionì„ ë§Œë“­ë‹ˆë‹¤. sessionNameìœ¼ë¡œ ì„¸ì…˜ì„ ê´€ë¦¬í•˜ê¸° ìœ„í•´ customeSessionIdë¥¼ ì„¤ì •í•©ë‹ˆë‹¤. Serverì—ì„œ Objectë¡œ Sessionì„ ê´€ë¦¬í•˜ë„ë¡ êµ¬í˜„í–ˆì§€ë§Œ ì„¤ëª…ì€ ìƒëµí•˜ê² ìŠµë‹ˆë‹¤.
</div>

```java
@RequestMapping(value = "/createSession", method = RequestMethod.POST)
public ResponseEntity<String> createSession(@RequestBody Map<String, Object> params) {
    String sessionName = (String) params.get("sessionName");

    // SessionPropertiesë¥¼ ì„¤ì •í•´ì¤€ë‹¤
    SessionProperties sessionProperties = new SessionProperties.Builder().customSessionId(sessionName).build();

    Session session = openViduModel.getOpenvidu().createSession(sessionProperties);
    return ResponseEntity.ok(sessionName);
}
```

<div>
ì´í›„ì— Clientì—ì„œ Session ì—°ê²°ì„ ìœ„í•œ í† í°ì„ ìš”ì²­í•©ë‹ˆë‹¤. Serverì—ì„œëŠ” í•´ë‹¹í•˜ëŠ” Sessionì— Connectionì„ ë§Œë“¤ê³  Connectionì˜ Tokenì„ ë°˜í™˜í•©ë‹ˆë‹¤.
</div>

```java
@RequestMapping(value = "/getToken", method = RequestMethod.POST)
public ResponseEntity<String> getToken(@RequestBody Map<String, Object> params) {
    String sessionName = (String) params.remove("sessionName");

    // ConnectionPropertiesë¥¼ ì„¤ì •í•´ì¤€ë‹¤
    ConnectionProperties connectionProperties = ConnectionProperties.fromJson(params).build();

    Connection connection = openViduModel.getMapSessions().get(sessionName).createConnection(connectionProperties);
    String token = connection.getToken();
    String connectionId = connection.getConnectionId();
    return ResponseEntity.ok(token);
}
```

<div>
Clientì—ì„œ ìœ ì €ê°€ Sessionì„ ë‚˜ê°ˆ ê²½ìš° ì—°ê²°í–ˆë˜ Connectionê³¼ Session ë“±ì˜ ì‚­ì œ ìš”ì²­ì„ ë³´ëƒ…ë‹ˆë‹¤. Serverì—ì„œëŠ” HashMapìœ¼ë¡œ Sessionì— í•´ë‹¹í•˜ëŠ” Token, Connection ë“±ì„ ê´€ë¦¬í•˜ê³  ìˆê¸° ë•Œë¬¸ì— ë§¤ìš° ê°„ë‹¨í•˜ê²Œ ì²˜ë¦¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
</div>
</div>
</details>

<details>
<summary> <h1> SSE(Server Side Events) </h1> </summary>
<div markdown="1">

### ì•Œë¦¼ ê¸°ëŠ¥ êµ¬í˜„

ë¡œê·¸ì¸ ì‹œ Http 1.1 í†µì‹ ì„ í†µí•´ SSEë¥¼ ìœ„í•œ ì—°ê²°ì„ ì„¤ì •í•©ë‹ˆë‹¤.<br>
ì•Œë¦¼ì˜ ê²½ìš° ë‹¨ë°©í–¥í†µì‹ ì´ê¸° ë•Œë¬¸ì— SSEì—°ê²°ì´ ìµœì ì˜ ì„ íƒì´ ë  ìˆ˜ ìˆì—ˆìŠµë‹ˆë‹¤.<br>

### BackEnd

```java
    // NotifcationController.java
    //ìš”ì²­ë³´ë‚¸ ìœ ì €ì˜ êµ¬ë…(ì—°ê²°) ìš”ì²­
    @GetMapping(value = "/subscribe")
    public ResponseEntity<SseEmitter> subscribe(HttpServletRequest request) throws IOException {
        Integer userPk = ((User)SecurityContextHolder.getContext().getAuthentication().getPrincipal()).getUserPk();
        SseEmitter emitter = new SseEmitter(60 * 60 * 1000L); //ìƒˆë¡œìš´ ì—°ê²° ê°ì²´ ìƒì„±. ë§¤ê°œë³€ìˆ˜ë¡œ ë§Œë£Œì‹œê°„ ì¤„ ìˆ˜ ìˆë‹¤. 1ì‹œê°„.
        sseEmitters.add(userPk, emitter); //ê°ì²´ ë©”ëª¨ë¦¬ì— ì €ì¥.

  ...
        return ResponseEntity.ok(emitter);
    }
```

```java
//SseEmitter.java
package com.ssafy.server.notification.util;

import java.util.Map;
import java.util.concurrent.ConcurrentHashMap;
import java.util.concurrent.atomic.AtomicLong;
import lombok.extern.slf4j.Slf4j;
import org.springframework.stereotype.Component;
import org.springframework.web.servlet.mvc.method.annotation.SseEmitter;

@Component
@Slf4j
public class SseEmitters {

    private static final AtomicLong counter = new AtomicLong();

    private final Map<Integer, SseEmitter> emitters = new ConcurrentHashMap<>(); //thread-safeí•œ ìë£Œêµ¬ì¡°.

    public SseEmitter add(Integer userPk, SseEmitter emitter) {
        this.emitters.put(userPk, emitter);
        log.info("new emitter added: {}", emitter);
        log.info("emitter list size: {}", emitters.size());
        log.info("emitter list: {}", emitters);
        emitter.onCompletion(() -> {
            log.info("onCompletion callback");
            this.emitters.remove(userPk, emitter);
        });
        emitter.onTimeout(() -> {
            log.info("onTimeout callback");
            emitter.complete();
        });

        return emitter;
    }

    public SseEmitter getSseEmitter(Integer userPk){
        return emitters.get(userPk);
    }
    public void remove(Integer userPk, SseEmitter emitter){
        emitters.remove(userPk, emitter);
    }

}
```

### FrontEnd

ê¸°ë³¸ì ìœ¼ë¡œ EventSource ê°ì²´ë¥¼ ì´ìš©í•´ SSE ì—°ê²° ìš”ì²­ì„ ë³´ë‚¼ìˆ˜ ìˆì§€ë§Œ, í—¤ë”ì— ì¸ì¦ í† í°ì„ ì¶”ê°€í•˜ê¸°ìœ„í•´ EventSourcePolyfill ê°ì²´ë¥¼ ì‚¬ìš©í–ˆìŠµë‹ˆë‹¤.

```javascript
//notificatinoStore.js
  state: () => ({
...
    sse : undefined,
...
  }),
   async setSse() {
      const { setCookie, getCookie, removeCookie } = useCookie();
      this.sse = new EventSourcePolyfill(pref.app.api.protocol + pref.app.api.host + "/notifications/subscribe",{
        headers: {
          Authorization : getCookie("Authorization"),
          refreshToken : getCookie("refreshToken"),
          heartbeatTimeout: 120000,
          "Content-Type": "application/json",
        },
      });
...

      this.sse.addEventListener('message', (message) => {
        // const { data: receivedConnectData } = e;
        console.log(' \'message\' event data shoud be notificationID: ', message.data);  // "connected!"
 ...
```
</div>
</details>


<details>
<summary> <h1> ë…¸ë˜ ë°ì´í„° </h1> </summary>
<div markdown="1">

## í¼í™íŠ¸ ìŠ¤ì½”ì–´

### í‰ê°€ ë°ì´í„°
ë©œë¡œë”” ì•…ë³´ë¥¼ í† ëŒ€ë¡œ MML(music macro language) ë°ì´í„°ë¥¼ ë§Œë“­ë‹ˆë‹¤. MML ë°ì´í„°ëŠ” í…œí¬, ì˜¥íƒ€ë¸Œ, ìŒê³„, ë°•ì, ê°€ì‚¬ ì •ë³´ë¥¼ ë‹´ê³  ìˆìŠµë‹ˆë‹¤.

```
{
mmlData: `t68 o3 l4
  d'ë™'g.'í•´'f+8'ë¬¼'e'ê³¼\t' g'ë°±'d'ë‘'c-'ì‚°'d'ì´\n' g'ë§ˆ'a8'ë¥´'b8'ê³ \t'b+.'ë‹³'b8'ë„' a2'ë¡\n'.r
  >d.'í•˜'c8'ëŠ'<b'ë‹˜'a'ì´\t' g'ë³´'f+8'ìš°'e8d'í•˜'c-'ì‚¬\n' d'ìš°'g'ë¦¬'a8'ë‚˜'a8'ë¼\t'b'ë§Œ' g2.'ì„¸\n'r
  f+.'ë¬´'g8a'ê¶'f+'í™”\t' b.'ì‚¼'>c8d'ì²œ'<b'ë¦¬\n' a'í™”'g'ë ¤'f+'ê°•'g a2.'ì‚°\n'r
  >d.'ëŒ€'c8'í•œ'<b'ì‚¬'a'ëŒ\t' g'ëŒ€'f+8'í•œ'e8d'ìœ¼'c-'ë¡œ\n' d'ê¸¸'g'ì´\t'a8'ë³´'a8'ì „'b'í•˜'g2.'ì„¸\n'r`
}
```

MML ë°ì´í„°ë¥¼ íŒŒì‹±í•œ ê²°ê³¼ë¡œ, ìŒê³„ ë° í•´ë‹¹ ìŒì˜ ì‹œê°„ ë°ì´í„°ë¥¼ ê°€ì§€ê³  í™”ë©´ì— ë ˆë”ë§ í•©ë‹ˆë‹¤.

### ì‚¬ìš©ì ì…ë ¥
ë°ì´í„° ì‹ í˜¸ë¥¼ ì£¼íŒŒìˆ˜ë¡œ ë°”ê¿”ì£¼ëŠ” í‘¸ë¦¬ì— ë³€í™˜ì„ í†µí•´, ì…ë ¥ìœ¼ë¡œ ë“¤ì–´ì˜¨ ë°ì´í„°ë¥¼ ì£¼íŒŒìˆ˜ë¡œ ë°”ê¾¸ê³  ì£¼íŒŒìˆ˜ë¥¼ ë‹¤ì‹œ ìŒê³„ë¡œ íŒŒì‹±í•©ë‹ˆë‹¤.
ìŒê³„ì™€ ì‹œê°„ë°ì´í„°ë¥¼ ê¸°ë°˜ìœ¼ë¡œ í™”ë©´ì— ë Œë”ë§í•©ë‹ˆë‹¤. ì´ë¥¼ í‰ê°€ ë°ì´í„°ì™€ ë¹„êµí•©ë‹ˆë‹¤.

```
correlate(buffer, sampleRate) {
    if (this.isSilentBuffer(buffer)) return -1; // ë¬´ìŒ ë²„í¼ì¸ì§€ í™•ì¸

    const threshold = 0.2; // ì„ê³„ê°’ ì„¤ì •
    const buf = this.trimBuffer(buffer, threshold); // ì„ê³„ê°’ì„ ê¸°ì¤€ìœ¼ë¡œ ë²„í¼ ìë¥´ê¸°
    const size = buf.length; // ë²„í¼ í¬ê¸°

    const c = new Array(size).fill(0); // êµì°¨ ìƒê´€ í•¨ìˆ˜ ë°°ì—´ ì´ˆê¸°í™”

    // êµì°¨ ìƒê´€ í•¨ìˆ˜ ê³„ì‚°
    for (let i = 0; i < size; i++) {
      for (let j = 0; j < size - i; j++) {
        c[i] = c[i] + buf[j] * buf[j + i];
      }
    }

    let d = 0;
    while (c[d] > c[d + 1]) d++; // ìµœëŒ€ê°’ ìœ„ì¹˜ ê³„ì‚°

    let maxval = -1,
      maxpos = -1;
    // ìµœëŒ€ê°’ ì°¾ê¸°
    for (let i = d; i < size; i++) {
      if (c[i] > maxval) {
        maxval = c[i];
        maxpos = i;
      }
    }

    let T0 = maxpos;
    const x1 = c[T0 - 1],
      x2 = c[T0],
      x3 = c[T0 + 1];
    const a = (x1 + x3 - 2 * x2) / 2;
    const b = (x3 - x1) / 2;
    if (a) T0 = T0 - b / (2 * a);

    return sampleRate / T0; // ì£¼íŒŒìˆ˜ ë°˜í™˜
  }
```

## ê°€ì‚¬

MML ë°ì´í„°ë¥¼ íŒŒì‹±í•œ ê²°ê³¼ì—ëŠ” ìŒê³¼ ê·¸ ìŒì— í•´ë‹¹ í•˜ëŠ” ê°€ì‚¬, ê·¸ë¦¬ê³  ê·¸ ìŒì´ ì‹œì‘í•˜ëŠ” ì‹œê°„ê°’(ë…¸ë˜ ì‹œì‘ì‹œê°„ 0ì¸ ê¸°ì¤€)ì´ ìˆìŠµë‹ˆë‹¤.
ì´ ë°ì´í„°ë¥¼ í•œë²ˆë” íŒŒì‹±í•˜ì—¬ ì¤„ë°”ê¿ˆì„ ê¸°ì¤€ìœ¼ë¡œ ë§ˆë”” ë³„ ì‹œì‘ ì‹œê°„ì„ ë‹´ê³  ìˆëŠ” ë°ì´í„°ë¥¼ ë°˜í™˜ë°›ìŠµë‹ˆë‹¤.
ë…¸ë˜ ì‹œì‘ ì‹œ, ì‹œê°„ì„ ë³€ìˆ˜ì— ì €ì¥í•˜ê³ , ì• ë‹ˆë©”ì´ì…˜ì´ ì§„í–‰ë˜ëŠ” ë™ì•ˆ ê³„ì†í•´ì„œ (í˜„ì¬ ì‹œê°„) - (ë…¸ë˜ ì‹œì‘ ì‹œê°„)ê°’ì„ ê°±ì‹ í•˜ë©°,
ê·¸ ê°’ì´ ê°€ì‚¬ ë§ˆë””ì˜ ì‹œì‘ ì‹œê°„ì„ ë„˜ì–´ ê°€ë©´ ë Œë”ë§ í•˜ëŠ” ë°©ì‹ìœ¼ë¡œ êµ¬í˜„í•˜ì˜€ìŠµë‹ˆë‹¤.

```
// ì• ë‹ˆë©”ì´ì…˜ í•¨ìˆ˜ ë‚´ë¶€
if((Date.now() - this.startTimeRef) >= this.lyrics[this.lyricIndex-1].start+this.prelude) {
          if(this.lyricFlag) {  // ìœ—ê°€ì‚¬ ì—…ë°ì´íŠ¸
            this.drawer.lyricUpper = this.lyrics[this.lyricIndex].lyric;
            this.lyricFlag = !this.lyricFlag
            this.drawer.lyricFlag = !this.drawer.lyricFlag
            this.lyricIndex++;
          } else {  // ì•„ë«ê°€ì‚¬ ì—…ë°ì´íŠ¸
            this.drawer.lyricLower = this.lyrics[this.lyricIndex].lyric;
            this.lyricFlag = !this.lyricFlag
            this.drawer.lyricFlag = !this.drawer.lyricFlag
            this.lyricIndex++;
          }
}
```
</div>
</details>


# ë””ë ‰í† ë¦¬ êµ¬ì¡°

```
front
â”œâ”€assets
â”‚  â”œâ”€font
â”‚  â”œâ”€icon
â”‚  â””â”€img
â”œâ”€boot
â”œâ”€components
â”‚  â”œâ”€chat
â”‚  â””â”€karaoke
â”‚      â”œâ”€list
â”‚      â”œâ”€session
â”‚      â”œâ”€song
â”‚      â””â”€video
â”œâ”€css
â”œâ”€js
â”‚  â”œâ”€chat
â”‚  â”œâ”€comment
â”‚  â”œâ”€config
â”‚  â”œâ”€encrypt
â”‚  â”œâ”€feed
â”‚  â”œâ”€friends
â”‚  â”œâ”€hit
â”‚  â”œâ”€karaoke
â”‚  â”œâ”€like
â”‚  â”œâ”€perfectScore
â”‚  â”œâ”€song
â”‚  â””â”€user
â”œâ”€layouts
â”œâ”€pages
â”œâ”€router
â””â”€stores

server
â”œâ”€api
â”œâ”€audit
â”œâ”€auth
â”‚  â”œâ”€controller
â”‚  â”œâ”€model
â”‚  â”‚  â”œâ”€dto
â”‚  â”‚  â””â”€entity
â”‚  â”œâ”€repository
â”‚  â”œâ”€service
â”‚  â””â”€util
â”œâ”€chat
â”‚  â”œâ”€controller
â”‚  â”œâ”€model
â”‚  â”œâ”€repository
â”‚  â””â”€service
â”œâ”€comment
â”‚  â”œâ”€controller
â”‚  â”œâ”€error
â”‚  â”œâ”€model
â”‚  â”œâ”€repository
â”‚  â””â”€service
â”œâ”€common
â”‚  â”œâ”€error
â”‚  â”œâ”€filter
â”‚  â””â”€util
â”œâ”€config
â”œâ”€feed
â”‚  â”œâ”€controller
â”‚  â”œâ”€error
â”‚  â”œâ”€model
â”‚  â”œâ”€rank
â”‚  â”‚  â”œâ”€document
â”‚  â”‚  â””â”€service
â”‚  â”œâ”€repository
â”‚  â””â”€service
â”œâ”€friends
â”‚  â”œâ”€controller
â”‚  â”œâ”€model
â”‚  â”‚  â””â”€dto
â”‚  â”œâ”€repository
â”‚  â””â”€service
â”œâ”€hit
â”‚  â”œâ”€controller
â”‚  â”œâ”€document
â”‚  â”œâ”€error
â”‚  â”œâ”€model
â”‚  â”œâ”€repository
â”‚  â””â”€service
â”œâ”€karaoke
â”‚  â”œâ”€controller
â”‚  â”œâ”€model
â”‚  â”œâ”€repository
â”‚  â””â”€service
â”œâ”€like
â”‚  â”œâ”€controller
â”‚  â”œâ”€document
â”‚  â”œâ”€error
â”‚  â”œâ”€model
â”‚  â”œâ”€repository
â”‚  â””â”€service
â”œâ”€notification
â”‚  â”œâ”€cotnoller
â”‚  â”œâ”€dto
â”‚  â”œâ”€entity
â”‚  â”œâ”€repository
â”‚  â”œâ”€service
â”‚  â””â”€util
â”œâ”€point
â”‚  â”œâ”€controller
â”‚  â”œâ”€model
â”‚  â”‚  â”œâ”€dto
â”‚  â”‚  â””â”€entity
â”‚  â”œâ”€repository
â”‚  â””â”€service
â”œâ”€song
â”‚  â”œâ”€controller
â”‚  â”œâ”€model
â”‚  â”‚  â””â”€entity
â”‚  â”œâ”€repository
â”‚  â””â”€service
â””â”€user
    â”œâ”€controller
    â”œâ”€document
    â”œâ”€error
    â”œâ”€model
    â”œâ”€repository
    â”œâ”€secure
    â”œâ”€service
    â””â”€util
```

<br />
<br />
<br />

---

# firstPjtTest

ê³µí†µí…ŒìŠ¤íŠ¸

## src/pages/HomePage.vue

-   vertical carousel
-   ì¼ë‹¨ í˜ì´ì§€ ë¬¸êµ¬ë§Œ ê¸°ì…í•¨
-   ë¡œê·¸ì¸/íšŒì›ê°€ì… ì§„í–‰ë˜ëŠ” ëª¨ë‹¬ ë§Œë“¦(src/components/StartTest.vue)
-   > src/components/SignIn.vueëŠ” ë¡œê·¸ì¸ ëª¨ë‹¬, íšŒì›ê°€ì… ëª¨ë‹¬ ë”°ë¡œ ë§Œë“  ê²ƒ

-   ì¨ë“œ íŒŒí‹° ë¡œê·¸ì¸ì€ ë” ê³µë¶€í•´ì•¼ í•¨
-   í™ˆí˜ì´ì§€ ë°°ê²½ìƒ‰, ì•„ì´ì½˜, gif ì¶”í›„ ì¶”ê°€ í•´ì•¼í•¨

# OPENVIDU TEST

## ê¸°ì¡´ server ë³€ê²½ì 

-   application.properities ê°’ ì¶”ê°€
-   OpenViduAPI.java íŒŒì¼ ì¶”ê°€
-   build.gradleì— dependency ì¶”ê°€

## DOCKERì— OPENVIDU ë„ìš°ê¸°

-   DOCKER ì„¤ì¹˜ í›„, cmd ì°½ì—ì„œ

```
docker run -p 4443:4443 --rm -e OPENVIDU_SECRET=MY_SECRET -e OPENVIDU_RECORDING=true -e OPENVIDU_RECORDING_PATH=/opt/openvidu/recordings -v /var/run/docker.sock:/var/run/docker.sock -v /opt/openvidu/recordings:/opt/openvidu/recordings openvidu/openvidu-dev:2.29.0
```

## ë°±ì„œë²„ëŠ” ê·¸ëŒ€ë¡œ ì‹¤í–‰(port=5000)

## í”„ë¡ íŠ¸ ì„œë²„ ë„ìš°ê¸°

```
cd S10P12A705/front
npm install
npm run serve
```

-   ì´í›„ localhost:8080ìœ¼ë¡œ ì ‘ì†í•´ì„œ í™•ì¸
-   localhost:4443ì—ì„œ connectionTest ê°€ëŠ¥
-   í•„í„° ì¶”ê°€

## ELK stack ì„¤ì¹˜ ë° í™•ì¸í•˜ê¸°

### íŒ¨í‚¤ì§€ ëª©ë¡ ì—…ë°ì´íŠ¸

```
sudo apt-get update
```

### Docker ì„¤ì¹˜

```
sudo apt-get install docker.io
```

### Docker ì„œë¹„ìŠ¤ ì‹œì‘

```
sudo systemctl start docker
```

### ë¶€íŒ… ì‹œì— Docker ìë™ ì‹¤í–‰ ì„¤ì •

```
sudo systemctl enable docker
```

### Docker Compose ì„¤ì¹˜

```
sudo apt-get install docker-compose
```

### gedit í…ìŠ¤íŠ¸ í¸ì§‘ê¸° ì„¤ì¹˜

```
sudo apt-get install gedit
```

```
$ mkdir [í”„ë¡œì íŠ¸ í´ë”]
$ cd [í”„ë¡œì íŠ¸ í´ë”]
$ gedit docker-compose.yml
```

// docker-compose.yml

```
version: '3.6'
services:
  Elasticsearch:
    image: elasticsearch:7.17.16
    container_name: elasticsearch
    restart: always
    volumes:
    - elastic_data:/usr/share/elasticsearch/data/
    environment:
      ES_JAVA_OPTS: "-Xmx256m -Xms256m"
      discovery.type: single-node
    ports:
    - '9200:9200'
    - '9300:9300'
    networks:
      - elk

  Logstash:
    image: logstash:7.17.16
    container_name: logstash
    restart: always
    volumes:
    - ./logstash/:/logstash_dir
    command: logstash -f /logstash_dir/logstash.conf
    depends_on:
      - Elasticsearch
    ports:
    - '9600:9600'
    environment:
      LS_JAVA_OPTS: "-Xmx256m -Xms256m"
    networks:
      - elk

  Kibana:
    image: kibana:7.17.16
    container_name: kibana
    restart: always
    ports:
    - '5601:5601'
    environment:
      - ELASTICSEARCH_URL=http://elasticsearch:9200
    depends_on:
      - Elasticsearch
    networks:
      - elk
volumes:
  elastic_data: {}

networks:
  elk:

```

// end of docker-compose.yml

```
$ mkdir logstash
$ cd logstash
$ gedit logstash.conf
```

// mysql ì„¤ì •

```
# mysql connector java jar ë‹¤ìš´ë¡œë“œ
wget https://repo1.maven.org/maven2/mysql/mysql-connector-java/8.0.30/mysql-connector-java-8.0.30.jar

# ì••ì¶• í•´ì œ
tar -xzf mysql-connector-java-8.0.30.tar.gz

# Logstash ì„¤ì¹˜ ë””ë ‰í† ë¦¬ë¡œ ì´ë™
cd [logstash_dir]

# ë‹¤ìš´ë¡œë“œ ë°›ì€ JAR íŒŒì¼ì„ í•´ë‹¹ ë””ë ‰í† ë¦¬ë¡œ ì´ë™
mv /path/to/mysql-connector-java-8.0.30.jar /path/to/logstash/
```

// logstash.conf

```
# synchronization with elasticseasrch & mysql
input {

  jdbc {
    jdbc_connection_string => "jdbc:mysql://i10a705.p.ssafy.io:3306/testuser"
    jdbc_user => "root"
    jdbc_password => "1234"
    jdbc_driver_library => "/logstash_dir/mysql-connector-java-8.0.30.jar"
    jdbc_driver_class => "com.mysql.cj.jdbc.Driver"

    statement => "SELECT * FROM likes WHERE timestamp > :sql_last_value"

    schedule => "*/10 * * * * *"
    use_column_value => true
    tracking_column => "timestamp"
    tracking_column_type => "timestamp"
    clean_run => false
    type => "like"
  }

  jdbc {
    jdbc_connection_string => "jdbc:mysql://i10a705.p.ssafy.io:3306/testuser"
    jdbc_user => "root"
    jdbc_password => "1234"
    jdbc_driver_library => "/logstash_dir/mysql-connector-java-8.0.30.jar"
    jdbc_driver_class => "com.mysql.cj.jdbc.Driver"

    statement => "SELECT * FROM hit WHERE timestamp > :sql_last_value"

    schedule => "*/10 * * * * *"
    use_column_value => true
    tracking_column => "timestamp"
    tracking_column_type => "timestamp"
    clean_run => false
    type => "hit"
  }
}

filter {
  # mutate {
  #  remove_field => ["introduction", "profile_img_url", "role", "user_key"]
  # }
}

output {
  if [type] == "like" {
    elasticsearch {
      hosts => ["elasticsearch:9200"]
      index => "likes"
    }
  }

  if [type] == "hit" {
  	elasticsearch {
  	  hosts => ["elasticsearch:9200"]
  	  index => "hit"
  	}
  }

  stdout { codec => rubydebug }
}


filter {
}

output {
  if [type] == "like" {
    elasticsearch {
      hosts => ["localhost:9200"]
      index => "like"                             # indexë¥¼ likeë¡œ ë°ì´í„° ë™ê¸°í™”
    }
  }

  if [type] == "view" {
    elasticsearch {
      hosts => ["localhost:9200"]
      index => "hit"                              # indexë¥¼ hitë¡œ ë°ì´í„° ë™ê¸°í™”
    }
  }
}

```

// end of logstash-config

```
$ docker-compose up
```

localhost:5601ë¡œ ì ‘ì†í•˜ë©´ í™•ì¸ ê°€ëŠ¥
